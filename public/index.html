<script>
    // Configuration Constants
    const KYC_BASE_URL = "https://api.cavach.hypersign.id";
    const SSI_BASE_URL = "https://api.entity.hypersign.id";

    /** * Application State Object 
     * Centralizes all tokens and IDs generated during the flow.
     */
    const state = {
        tokens: {
            kycAdmin: "",
            ssiAdmin: "",
            userBearer: ""
        },
        issuer: {
            did: "",
            methodId: ""
        },
        user: {
            did: "",
            methodId: ""
        },
        session: {
            id: "",
            extractionToken: ""
        },
        currentStep: "init"
    };

    /**
     * Step 1: Initialize Session
     * Fetches required tokens and session context from your local backend.
     */
    async function startKycProcess() {
        updateStatus("Initializing session...");
        try {
            const response = await fetch(`${window.location.origin}/get-required-tokens-and-session-for-a-user`);
            if (!response.ok) throw new Error("Failed to reach backend");

            const data = await response.json();

            // Map backend response to local state
            state.tokens.kycAdmin = data.kycAdminToken;
            state.tokens.ssiAdmin = data.ssiAdminToken;
            state.tokens.userBearer = data.userBearerToken;
            state.issuer.did = data.issuerDid;
            state.issuer.methodId = data.issuerVerificationMethodId;
            state.session.id = data.sessionId;
            state.user.did = data.userDid;
            state.user.methodId = data.userVerificationMethodId;

            showCameraUI('Capture ID Card (Front)', 'doc-extract');
        } catch (error) {
            handleError("Initialization Error", error);
        }
    }

    /**
     * Step 2: Document OCR Extraction
     * Sends the base64 image of the document to the KYC service.
     */
    async function processDocumentExtraction(base64Image) {
        updateStatus("Extracting data from document...");
        try {
            const response = await fetch(`${KYC_BASE_URL}/api/v1/e-kyc/verification/doc-ocr/extract`, {
                method: 'POST',
                headers: createHeaders(true),
                body: JSON.stringify({
                    tokenFrontDocumentImage: base64Image,
                    sessionId: state.session.id,
                    documentType: "PASSPORT"
                })
            });

            const result = await response.json();
            if (!result.success) throw new Error(result.message || "Extraction failed");

            state.session.extractionToken = result.data.extractionToken;
            showCameraUI("Take a Live Selfie", "liveness");
        } catch (error) {
            handleError("OCR Error", error);
        }
    }

    /**
     * Step 3: Face Match & Identity Verification
     * Matches the selfie against the extracted document data.
     */
    async function performIdentityMatch(base64Selfie) {
        updateStatus("Verifying identity match...");
        try {
            const response = await fetch(`${KYC_BASE_URL}/api/v1/e-kyc/verification/doc-ocr`, {
                method: 'POST',
                headers: {
                    ...createHeaders(true),
                    'x-issuer-did': state.issuer.did,
                    'x-issuer-did-ver-method': state.issuer.methodId
                },
                body: JSON.stringify({
                    extractionToken: state.session.extractionToken,
                    sessionId: state.session.id,
                    tokenFaceImage: base64Selfie,
                    bestImageTokenized: base64Selfie,
                    userDID: state.user.did,
                    countryCode: "IND"
                })
            });

            const result = await response.json();
            if (result.success) {
                await submitUserConsent(result.data.credentials);
            } else {
                throw new Error("Identity match failed.");
            }
        } catch (error) {
            handleError("Verification Error", error);
        }
    }

    /**
     * Step 4: User Consent & Presentation
     * Signs the verifiable credentials and completes the session.
     */
    async function submitUserConsent(credentials) {
        updateStatus("Finalizing verification...");
        try {
            const vp = await createSsiPresentation(credentials);
            const response = await fetch(`${KYC_BASE_URL}/api/v1/e-kyc/verification/user-consent`, {
                method: 'POST',
                headers: createHeaders(true),
                body: JSON.stringify({
                    sessionId: state.session.id,
                    presentation: vp.presentation
                })
            });

            const result = await response.json();
            displayFinalStep(result.data.redirectUrl);
        } catch (error) {
            handleError("Consent Error", error);
        }
    }

    /**
     * Helper: Creates Verifiable Presentation via SSI Service
     */
    async function createSsiPresentation(credentialDocuments) {
        const response = await fetch(`${SSI_BASE_URL}/api/v1/presentation`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${state.tokens.ssiAdmin}`
            },
            body: JSON.stringify({
                credentialDocuments,
                holderDid: state.user.did,
                challenge: state.session.id,
                domain: window.location.origin,
                verificationMethodId: state.user.methodId
            })
        });
        return await response.json();
    }

    /**
     * Utility: Generates repeated headers for KYC/SSI calls
     */
    function createHeaders(includeUserToken = false) {
        const headers = {
            'Content-Type': 'application/json',
            'x-kyc-access-token': state.tokens.kycAdmin,
            'X-Ssi-Access-Token': state.tokens.ssiAdmin
        };
        if (includeUserToken) {
            headers['Authorization'] = `Bearer ${state.tokens.userBearer}`;
        }
        return headers;
    }

    // --- UI Logic Helpers ---

    function updateStatus(msg) {
        document.getElementById('status-msg').innerText = msg;
    }

    function handleError(title, err) {
        console.error(`${title}:`, err);
        alert(`${title}: ${err.message}`);
        location.reload();
    }

    function displayFinalStep(url) {
        document.getElementById('camera-container').classList.add('hidden');
        document.getElementById('step-final').classList.remove('hidden');
        document.getElementById('result-text').innerText = `Verification Successful. Redirecting to: ${url || 'Dashboard'}`;
    }
</script>